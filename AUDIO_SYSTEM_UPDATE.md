# 音频系统更新说明

## 更新内容

### 1. 背景音乐播放系统
- 不再使用钢琴音色播放 MIDI 音符
- 改为播放与 MIDI 文件同名的 MP3 音频文件
- 例如：`midi/1.mid` 对应 `midi/1.mp3`

### 2. 音频对齐
- **精确对齐**：音频提前播放，使得第一个黑块到达触发线时，音频正好播放到第一个音符的时间点
- **计算公式**：
  - 黑块到触发线的距离 = `(firstNoteTime × originalBaseSpeed × 60) + bufferDistance`
  - 移动到触发线需要的时间 = `距离 / (currentSpeed × 60)`
  - 音频开始时间 = `firstNoteTime - 移动时间`
- 黑块下落与音频播放完美同步
- 触发黑块时不再播放钢琴音符，只显示视觉效果

### 3. 音频速度同步
- **实时加速**：背景音乐播放速度随黑块速度变化而调整
- **速度倍数**：每完成一轮，速度提升 1.25 倍
- **平滑过渡**：速度变化实时应用，无延迟

### 4. 音频控制
- **游戏开始**：从第一个黑块时间点播放背景音乐
- **游戏暂停/结束**：暂停背景音乐
- **继续游戏**：从暂停位置恢复播放（保持当前速度）
- **重新开始**：从第一个黑块时间点重新播放（速度重置为 1.0x）
- **完成一轮**：从第一个黑块时间点重新播放（使用新的速度倍数）
- **展开灵动岛**：暂停游戏和背景音乐
- **收起灵动岛**：恢复游戏和背景音乐
- **切换歌曲**：停止当前背景音乐，加载新的音乐文件

### 5. 音频输出优化
- **原始音质**：背景音乐直接连接到音频输出，不经过音频处理链
- **独立音量**：背景音乐使用独立的音量控制节点
- **原始音量**：默认音量为 1.0（100%），保持音频文件的原始音量

### 6. 新增功能

#### AudioEngine 类新增方法：
```javascript
// 加载背景音乐
await audioEngine.loadBGM(audioPath)

// 播放背景音乐（从指定时间开始，支持播放速度）
audioEngine.playBGM(startTime, playbackRate)

// 停止背景音乐
audioEngine.stopBGM()

// 暂停背景音乐
audioEngine.pauseBGM()

// 恢复背景音乐
audioEngine.resumeBGM()

// 获取当前播放时间
audioEngine.getBGMCurrentTime()

// 设置背景音乐播放速度（实时调整）
audioEngine.setBGMPlaybackRate(rate)

// 设置背景音乐音量
audioEngine.setBGMVolume(volume)
```

### 7. 使用方法

#### 添加新的音乐：
1. 将 MIDI 文件放入 `midi/` 文件夹（如 `2.mid`）
2. 将对应的 MP3 文件放入同一文件夹（如 `2.mp3`）
3. 在 `game.js` 的 `getMidiFiles()` 函数中添加文件路径：
```javascript
async function getMidiFiles() {
    return [
        'midi/1.mid',
        'midi/2.mid'  // 新增
    ];
}
```

### 8. 技术细节

#### 音频播放
- 背景音乐通过 Web Audio API 的 `AudioBufferSourceNode` 播放
- 支持精确的时间控制和暂停/恢复功能
- 音频直接连接到 `AudioContext.destination`，不经过音频处理链
- 使用独立的 `GainNode` 控制音量

#### 速度同步
- 使用 `playbackRate` 属性实时调整播放速度
- 速度变化范围：1.0x ~ 无限制（随游戏进度增加）
- 速度调整公式：`当前速度 = 原始速度 × 速度倍数`

#### 时间对齐
- 计算第一个 MIDI 音符的时间：`firstNoteTime = midiNotes[0].time`
- 从该时间点开始播放：`audioEngine.playBGM(firstNoteTime, speedMultiplier)`
- 确保音频与黑块完美同步

### 9. 优势

- **完美同步**：音频从第一个黑块开始，与游戏完美对齐
- **实时加速**：音频速度随游戏速度变化，保持同步
- **原始音质**：不经过音频处理，保持 MP3 文件的原始音质
- **更低的性能消耗**：减少音频处理负担
- **更灵活的音乐选择**：可以使用任何音频文件作为背景音乐

## 测试建议

1. 确保 `midi/1.mp3` 文件存在
2. 启动游戏，检查背景音乐是否从第一个黑块开始播放
3. 测试暂停/恢复功能（音频应同步暂停和恢复）
4. 测试重新开始功能（音频应从第一个黑块重新开始）
5. 测试完成一轮后的音乐重播（音频应以新的速度重新播放）
6. 观察速度变化时音频是否同步加速

## 注意事项

- MP3 文件名必须与 MIDI 文件名完全匹配（除了扩展名）
- 如果 MP3 文件不存在，游戏仍可正常运行，但不会播放背景音乐
- 建议使用高质量的 MP3 文件（320kbps 或更高）以获得最佳音质
- 音频播放速度会随游戏进度增加，最高可达数倍速度
- 暂停游戏时，音频会自动暂停；继续游戏时，音频会从暂停位置恢复
