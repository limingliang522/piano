# 音频和黑块同步验证测试

## 测试目的

验证音频播放速度和黑块移动速度是否完美同步，确保它们共用同一个加速度源。

## 测试步骤

### 1. 基础同步测试（1.0x 速度）

1. 启动游戏，选择任意 MIDI 文件
2. 点击"开始游戏"
3. **观察第一个黑块**：
   - 记录黑块到达触发线（白色横线）的时间
   - 同时听音频，确认音符播放时间
4. **预期结果**：
   - 黑块到达触发线时，音频正好播放到对应的音符
   - 视觉和听觉完全同步

### 2. 加速同步测试（1.25x, 1.56x, 1.95x...）

1. 完成第一轮（所有黑块通过触发线）
2. 游戏自动进入下一轮，速度提升到 1.25x
3. **观察同步性**：
   - 黑块移动速度是否加快
   - 音频播放速度是否同步加快
   - 黑块到达触发线时，音频是否仍然同步
4. **重复测试**：
   - 继续完成多轮，速度持续提升
   - 在 2.0x、3.0x 等高速下验证同步性

### 3. 长时间稳定性测试

1. 连续游戏 5-10 轮
2. **观察是否出现漂移**：
   - 黑块和音频是否逐渐不同步
   - 高速下是否仍然保持同步
3. **预期结果**：
   - 无论速度多快，同步性始终保持
   - 不会出现累积误差或漂移

## 验证要点

### ✅ 正确的表现

- 黑块到达触发线时，音频正好播放到对应的音符
- 速度提升后，音频和黑块同步加速
- 多轮游戏后，同步性保持稳定
- 控制台显示：`速度: X.XXx`，音频和黑块速度一致

### ❌ 错误的表现

- 黑块到达触发线时，音频还没播放到该音符（黑块太快）
- 黑块到达触发线时，音频已经播放过该音符（黑块太慢）
- 速度提升后，音频和黑块加速不一致
- 多轮游戏后，出现明显的漂移

## 技术验证

### 控制台日志检查

启动游戏时，检查控制台输出：

```
🎵 第一个音符时间: X.XX秒
⏱️ 黑块到达触发线需要: X.XX秒游戏时间
🎵 音频从 X.XX秒 开始播放
✅ 预期：游戏开始后 X.XX秒，黑块到达触发线，音频播放到 X.XX秒
```

### 速度倍数验证

完成一轮后，检查控制台输出：

```
🎮 统一速度控制：originalBaseSpeed = 0.XXXX, speedMultiplier = X.XXx
```

确认：
- `originalBaseSpeed` 保持不变
- `speedMultiplier` 正确增加（每轮 ×1.25）

## 调试工具

### 查看实时速度

在游戏界面右上角：
- `速度: X.XXx` - 当前速度倍数
- 这个值应该与音频播放速度和黑块移动速度一致

### 查看黑块数量

在游戏界面：
- `方块: XXX` - 当前场景中的黑块数量
- 应该等于 MIDI 文件中的音符数量

## 常见问题

### Q: 如何判断是否同步？

A: 最简单的方法是同时观察和听：
- 看到黑块到达触发线
- 听到音符播放
- 如果视觉和听觉同时发生，就是同步的

### Q: 高速下很难判断是否同步？

A: 可以：
1. 降低游戏速度（修改 `speedMultiplier` 初始值）
2. 使用慢动作录屏工具
3. 观察多个连续的音符，看是否有累积误差

### Q: 如何测试极端情况？

A: 修改代码中的速度参数：
```javascript
// 在 game.js 中
speedMultiplier = 5.0;  // 测试 5 倍速
```

## 测试报告模板

```
测试日期：____
测试人员：____
MIDI 文件：____

1. 基础同步（1.0x）：✅ / ❌
   - 第一个音符同步：____
   - 中间音符同步：____
   - 最后音符同步：____

2. 加速同步：
   - 1.25x：✅ / ❌
   - 1.56x：✅ / ❌
   - 1.95x：✅ / ❌
   - 2.44x：✅ / ❌

3. 长时间稳定性：✅ / ❌
   - 测试轮数：____
   - 是否出现漂移：____

4. 其他问题：
   ____________________
```

## 修复历史

- **2024-11-23**：实现统一时间控制系统
  - 音频和黑块共用 `speedMultiplier` 作为唯一加速度源
  - 移除独立的 `midiSpeed` 计算
  - 确保所有速度计算基于 `originalBaseSpeed * speedMultiplier`
