# 音频同步测试指南

## 测试项目

### 1. 音频对齐测试
**目标**：验证音频提前播放，第一个黑块到达触发线时音频正好播放到第一个音符

**步骤**：
1. 启动游戏
2. 观察音频立即开始播放（从音频文件的开头或计算出的位置）
3. 观察第一个黑块移动到触发线
4. 确认当黑块到达触发线时，音频正好播放到第一个音符的声音
5. 检查控制台日志：
   - `🎵 第一个音符时间: X.XX秒`
   - `📏 黑块到触发线距离: X.XX`
   - `⏱️ 移动到触发线需要: X.XX秒`
   - `🎵 音频从 X.XX秒 开始播放`

**预期结果**：
- 音频在游戏开始时立即播放（提前播放）
- 第一个黑块到达触发线时，音频正好播放到第一个音符的时间点
- 音频与黑块完美同步

---

### 2. 音频速度同步测试
**目标**：验证音频速度随游戏速度变化

**步骤**：
1. 完成第一轮游戏（触发所有黑块）
2. 观察速度倍数变化：`速度: 1.25x`
3. 确认音频播放速度也提升到 1.25x
4. 继续完成更多轮次，观察速度持续增加

**预期结果**：
- 每完成一轮，速度倍数 × 1.25
- 音频播放速度实时调整
- 黑块移动速度与音频速度保持同步
- 控制台显示：`🎵 背景音乐速度调整为: X.XXx`

---

### 3. 暂停/恢复测试
**目标**：验证暂停时音频同步暂停

**步骤**：
1. 游戏进行中，碰撞黑块触发游戏结束
2. 确认音频暂停
3. 点击"继续游戏"
4. 确认音频从暂停位置恢复播放

**预期结果**：
- 游戏结束时，音频立即暂停
- 继续游戏时，音频从暂停位置恢复
- 音频速度保持不变
- 控制台显示：`⏸️ 背景音乐暂停在 X.XX秒`

---

### 4. 重新开始测试
**目标**：验证重新开始时音频重置

**步骤**：
1. 游戏结束后，点击"重新开始"
2. 确认音频从第一个黑块时间点重新播放
3. 确认速度重置为 1.0x

**预期结果**：
- 音频从第一个黑块时间点开始
- 速度倍数重置为 1.0x
- 黑块和音频重新同步
- 控制台显示：`🎵 背景音乐重新开始播放，从 X.XX秒`

---

### 5. 完成一轮测试
**目标**：验证完成一轮后音频以新速度重播

**步骤**：
1. 完成第一轮（触发所有黑块）
2. 观察自动进入第二轮
3. 确认音频从第一个黑块时间点重新播放
4. 确认播放速度为 1.25x

**预期结果**：
- 音频自动重新开始
- 播放速度为新的速度倍数
- 黑块移动速度与音频速度匹配
- 控制台显示：`🎵 背景音乐重新开始播放（新一轮），从 X.XX秒，速度: X.XXx`

---

### 6. 音质测试
**目标**：验证音频使用原始音质

**步骤**：
1. 播放游戏音频
2. 对比原始 MP3 文件的音质
3. 确认没有额外的音频处理效果

**预期结果**：
- 音频清晰，无失真
- 没有混响、压缩等效果
- 音量适中，不会过大或过小
- 音质与原始 MP3 文件一致

---

## 调试技巧

### 查看控制台日志
关键日志信息：
```
🎵 第一个音符时间: X.XX秒
🎵 背景音乐从 X.XX秒 开始播放，速度: X.XXx
🎵 背景音乐速度调整为: X.XXx
⏸️ 背景音乐暂停在 X.XX秒
```

### 检查音频状态
在浏览器控制台输入：
```javascript
// 查看音频是否正在播放
audioEngine.bgmIsPlaying

// 查看当前播放时间
audioEngine.getBGMCurrentTime()

// 查看当前播放速度
audioEngine.bgmPlaybackRate

// 查看速度倍数
speedMultiplier
```

### 常见问题

**问题 1**：音频没有播放
- 检查 `midi/1.mp3` 文件是否存在
- 检查浏览器控制台是否有错误
- 确认音频上下文已启动

**问题 2**：音频与黑块不同步
- 检查第一个音符时间是否正确计算
- 确认播放速度是否正确应用
- 查看控制台日志确认时间点

**问题 3**：音频速度没有变化
- 确认 `starsEarned > 0`（只有完成一轮后才会加速）
- 检查 `setBGMPlaybackRate()` 是否被调用
- 查看控制台日志确认速度调整

**问题 4**：暂停后恢复不正确
- 检查 `bgmPauseTime` 是否正确记录
- 确认 `resumeBGM()` 使用正确的速度
- 查看控制台日志确认暂停时间

---

## 性能监控

### 音频延迟
- 正常延迟：< 50ms
- 如果延迟过大，检查音频文件大小和格式

### CPU 使用率
- 背景音乐播放应该不会显著增加 CPU 使用率
- 如果 CPU 使用率过高，检查是否有其他音频处理

### 内存使用
- 音频文件解码后会占用内存
- 建议使用压缩率适中的 MP3 文件（128-320kbps）

---

## 成功标准

✅ 音频从第一个黑块时间点开始播放  
✅ 音频速度随游戏速度实时变化  
✅ 暂停时音频同步暂停  
✅ 恢复时音频从暂停位置继续  
✅ 重新开始时音频重置  
✅ 完成一轮后音频以新速度重播  
✅ 音质清晰，无失真  
✅ 音频与黑块完美同步
