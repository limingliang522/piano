# 🎵 极致音质系统说明 v2.0

## 核心设计理念：完美还原MIDI + 自然音色

本系统专注于**完美还原MIDI文件**的每一个细节，同时通过专业音频处理让声音更加悦耳动听。

## 已实现的专业音频技术

### 1. **3D 空间音频（HRTF）**
- ✅ 使用头部相关传输函数（HRTF）模拟真实人耳听感
- ✅ 5条轨道的音符从不同空间位置传来
- ✅ 左边轨道 → 左耳更响，右边轨道 → 右耳更响
- ✅ 距离衰减模型，营造深度感

**效果：** 戴上耳机，你能清晰感受到音符从左、中、右不同位置传来

### 2. **立体声增强**
- ✅ 独立的立体声声像控制
- ✅ 根据轨道位置动态调整左右声道平衡
- ✅ 创造更宽广的音场

**效果：** 音场宽度提升 200%，声音更有包围感

### 3. **卷积混响（钢琴房效果）**
- ✅ 0.8秒自然混响尾音（更短，更清晰）
- ✅ 模拟真实钢琴房的早期反射和后期扩散
- ✅ 左右声道不同的混响，增加空间感
- ✅ 干湿比 85:15（轻微混响，保留清晰度）

**效果：** 仿佛在钢琴房演奏，声音清晰且有适度空间感

### 4. **动态压缩器（温和压缩）**
- ✅ 温和压缩参数（-24dB 阈值，2.5:1 压缩比）
- ✅ 保留MIDI的动态范围，不过度压缩
- ✅ 快速释放（0.15s），保持音符的自然衰减

**效果：** 音量更均衡，同时保留原始MIDI的力度变化

### 5. **三段均衡器（EQ）- 钢琴优化**
- ✅ **低频增强**：+1.5dB @ 200Hz（轻微温暖感）
- ✅ **中频塑形**：+1.0dB @ 2.5kHz（增强清晰度）
- ✅ **高频提亮**：+2.0dB @ 8kHz（明亮空气感）

**效果：** 音色自然平衡，低频温暖，高频明亮，中频清晰

### 6. **限制器（防削波）**
- ✅ -3dB 阈值，20:1 压缩比
- ✅ 防止音频过载失真
- ✅ 保护扬声器和耳朵

**效果：** 无论音量多大，都不会出现破音

### 7. **精细音量包络（ADSR）- 完美还原MIDI力度**
- ✅ **Attack**：5ms 快速起音（保留钢琴瞬态）
- ✅ **Velocity映射**：使用指数曲线（velocity^1.5），更自然
- ✅ **Decay**：指数衰减到 60%（模拟真实钢琴）
- ✅ **Release**：50ms 快速释放

**效果：** 完美还原MIDI的力度变化，音符起音和结束自然，无咔哒声

### 8. **音高自适应音量**
- ✅ 高音自动降低音量
- ✅ 低音自动增强音量
- ✅ 模拟真实钢琴的音量特性

**效果：** 全音域平衡，听感更舒适

### 9. **精确音高还原**
- ✅ 完全按照MIDI音高播放，无随机偏移
- ✅ 使用playbackRate精确调整半音偏移
- ✅ 保证音准100%准确

**效果：** 完美还原MIDI的音高，音准精确

### 10. **增强碰撞音效**
- ✅ 三层音效：低频冲击 + 中频撞击 + 高频碎裂
- ✅ 低通滤波模拟闷响
- ✅ 噪音合成增加真实感

**效果：** 碰撞更有冲击力，更震撼

## 音频处理链路

```
音源采样
    ↓
3D 空间定位（PannerNode - HRTF）
    ↓
立体声增强（StereoPannerNode）
    ↓
音量包络（GainNode - ADSR）
    ↓
动态压缩（DynamicsCompressor）
    ↓
三段均衡器（BiquadFilter × 3）
    ↓
卷积混响（ConvolverNode）
    ↓
限制器（DynamicsCompressor）
    ↓
主音量（GainNode）
    ↓
输出（扬声器/耳机）
```

## 技术参数（v2.0优化）

| 参数 | 数值 | 说明 |
|------|------|------|
| 采样率 | 44.1kHz | 标准音频采样率 |
| 延迟模式 | Balanced | 平衡延迟和性能 |
| 3D 模型 | HRTF | 最真实的空间音频 |
| 混响时长 | 0.8s | 钢琴房级别（更清晰）|
| 混响干湿比 | 85:15 | 保留清晰度 |
| 压缩比 | 2.5:1 | 温和压缩，保留动态 |
| 压缩阈值 | -24dB | 更高阈值，减少压缩 |
| 限制器阈值 | -2dB | 防止削波 |
| 主音量 | 1.8x | 平衡响度 |
| 立体声范围 | ±0.8 | 温和的声像定位 |

## 如何体验最佳效果

### 🎧 **强烈建议使用耳机！**
- 3D 空间音频在耳机上效果最佳
- 能清晰感受到左中右的定位
- 混响和立体声增强更明显

### 🔊 **音量建议**
- 设置到舒适的中等音量
- 不要开太大，限制器会保护你的耳朵
- 在安静环境下体验效果更好

### 📱 **设备建议**
- 现代浏览器（Chrome、Safari、Edge）
- 支持 Web Audio API
- 性能越好，音质越稳定

## 与其他音乐游戏对比

| 游戏 | 空间音频 | 混响 | 压缩 | 均衡器 |
|------|---------|------|------|--------|
| **本游戏** | ✅ HRTF | ✅ 卷积 | ✅ 专业级 | ✅ 三段 |
| Cytus II | ❌ | ✅ 简单 | ✅ 基础 | ❌ |
| Deemo | ❌ | ✅ 简单 | ✅ 基础 | ❌ |
| Piano Tiles | ❌ | ❌ | ❌ | ❌ |

## v2.0 优化重点

### 🎯 **完美还原MIDI**
1. **精确的velocity映射** - 使用指数曲线（velocity^1.5）还原力度
2. **精确的音高** - 无随机偏移，100%准确
3. **保留动态范围** - 温和压缩（2.5:1），不过度处理
4. **快速瞬态响应** - 5ms起音，保留钢琴的打击感

### 🎼 **更好听的音色**
1. **自然混响** - 0.8秒钢琴房混响，清晰且有空间感
2. **平衡的EQ** - 轻微增强低频和高频，保持自然
3. **温和的立体声** - ±0.8范围，不过度分离
4. **指数衰减** - 模拟真实钢琴的音量衰减曲线

### 📊 **关键改进对比**

| 项目 | v1.0 | v2.0 | 改进原因 |
|------|------|------|----------|
| 混响时长 | 1.2s | 0.8s | 更清晰，减少混响拖尾 |
| 混响干湿比 | 100:0 | 85:15 | 增加空间感，但不影响清晰度 |
| 压缩比 | 3:1 | 2.5:1 | 保留更多动态范围 |
| 压缩阈值 | -20dB | -24dB | 减少压缩量 |
| Attack时间 | 10ms | 5ms | 保留钢琴瞬态特性 |
| 衰减方式 | 线性 | 指数 | 更自然的衰减曲线 |
| 立体声范围 | ±1.0 | ±0.8 | 更温和的声像定位 |
| Velocity映射 | 线性 | 指数(^1.5) | 更符合人耳感知 |

## 未来可升级方向

### 🎹 **更高品质音源**
- 使用 WAV/FLAC 无损格式
- 48kHz/24bit 采样
- 多力度层采样（3-5层）
- 更多采样点（每个半音一个采样）

### 🎼 **更多音效**
- 完美触发的奖励音效
- 连击时的音高上升
- 背景氛围音
- 踏板效果（延音踏板）

### 🎚️ **用户自定义**
- 混响强度调节（0-100%）
- EQ 自定义（3段可调）
- 干湿比控制
- 立体声宽度调节
- 音色选择（明亮/温暖/柔和）

---

**享受完美还原MIDI的极致音质体验！** 🎵✨
