# 实现计划

- [x] 1. 创建核心渲染系统基础架构



  - 创建 `render-system.js` 文件，定义所有核心类的基本结构
  - 实现 RenderManager 类的基本框架和初始化逻辑
  - 建立各子系统之间的通信接口
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 2. 实现性能监控系统

  - [x] 2.1 实现 PerformanceMonitor 类


    - 编写帧时间计算和FPS统计逻辑
    - 实现环形缓冲区存储最近120帧的数据
    - 添加滑动窗口算法计算平均FPS
    - 集成 renderer.info 获取渲染统计数据
    - _需求: 9.1, 9.2, 9.3_

  - [x] 2.2 添加性能阈值检测

    - 实现 shouldReduceQuality() 方法（低于30 FPS持续3秒）
    - 实现 canIncreaseQuality() 方法（高于55 FPS持续5秒）
    - 添加性能数据导出接口
    - _需求: 1.3, 9.1_

  - [x] 2.3 创建性能统计UI面板


    - 在HTML中添加性能统计显示元素
    - 实现实时更新FPS、渲染调用次数、三角形数量的显示
    - 添加开发模式切换开关
    - _需求: 9.1, 9.2, 9.3, 9.4_

- [x] 3. 实现视锥剔除系统


  - [x] 3.1 创建 FrustumCuller 类

    - 实现视锥体更新逻辑（使用 Three.js Frustum）
    - 为音符方块添加包围球计算
    - 实现单个物体可见性检测方法
    - _需求: 2.1, 2.2, 2.4_

  - [x] 3.2 实现批量剔除优化

    - 编写批量物体剔除方法 cullObjects()
    - 添加距离剔除逻辑（超过150单位）
    - 实现剔除结果缓存机制
    - 添加剔除统计数据收集
    - _需求: 2.3, 2.4_

  - [x] 3.3 集成视锥剔除到游戏循环


    - 修改 updateNoteBlocks() 函数，在渲染前执行剔除
    - 只对可见物体执行碰撞检测和触发检测
    - 更新物体的 visible 属性控制渲染
    - _需求: 2.1, 2.2_


- [x] 4. 实现对象池系统


  - [x] 4.1 创建 ObjectPool 类

    - 实现对象池的基本数据结构（available 和 active 数组）
    - 编写 acquire() 和 release() 方法
    - 实现对象重置函数 resetNoteBlock()
    - 添加池容量限制（最大1000个对象）
    - _需求: 3.1, 3.2, 3.3, 3.4_

  - [x] 4.2 实现对象池预热和统计

    - 编写 warmup() 方法预创建初始对象（100个）
    - 实现 getStats() 方法返回池使用情况
    - 添加 clear() 方法清空对象池
    - _需求: 3.1, 3.4_

  - [x] 4.3 改造音符方块创建流程


    - 修改 createNoteBlock() 函数使用对象池
    - 更新 cleanupObjects() 函数将对象归还池而非销毁
    - 在游戏初始化时预热对象池
    - 测试对象重用是否正确工作
    - _需求: 3.2, 3.3_

- [x] 5. 实现LOD细节层次系统

  - [x] 5.1 创建共享几何体


    - 定义 SHARED_GEOMETRIES 对象存储所有LOD级别的几何体
    - 为普通方块创建高、中、低三个细节级别的几何体
    - 为超高方块创建对应的LOD几何体
    - 更新边缘线几何体以匹配LOD级别
    - _需求: 4.1, 4.2, 4.3_

  - [x] 5.2 实现 LODManager 类

    - 编写对象注册和注销方法
    - 实现距离计算和LOD级别判断逻辑（使用平方距离优化）
    - 编写几何体切换方法，保持材质和变换不变
    - 添加LOD统计数据收集
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [x] 5.3 集成LOD系统到渲染循环


    - 在 createNoteBlock() 中注册对象到LOD管理器
    - 在 animate() 循环中调用 lodManager.update()
    - 确保LOD切换不影响游戏逻辑
    - _需求: 4.4_

- [x] 6. 实现画质适配系统






  - [x] 6.1 定义画质预设配置

    - 创建 QUALITY_PRESETS 对象定义四个画质级别
    - 为每个级别配置阴影、像素比、抗锯齿、雾距离等参数
    - 定义LOD距离配置
    - _需求: 1.1, 1.2_


  - [x] 6.2 实现 QualityAdapter 类

    - 编写设备性能检测逻辑（GPU、内存、分辨率）
    - 实现 applyQualitySettings() 方法应用画质配置
    - 添加画质级别切换的防抖机制（5秒冷却）
    - 实现手动和自动模式切换
    - _需求: 1.1, 1.2, 1.4_


  - [x] 6.3 实现自动画质调整

    - 编写每秒检查性能数据的逻辑
    - 根据 PerformanceMonitor 的建议自动调整画质
    - 实现平滑过渡逻辑，避免突然的视觉变化
    - 添加画质变化的日志记录
    - _需求: 1.3, 10.1, 10.2, 10.3, 10.4_


- [x] 7. 实现批处理渲染系统




  - [x] 7.1 创建 BatchRenderer 类

    - 实现按材质类型分组的逻辑
    - 编写 addBatchable() 和 removeBatchable() 方法
    - 创建 InstancedMesh 对象用于批处理渲染
    - 设置每个批次最多1000个实例的限制
    - _需求: 6.1, 6.2_


  - [x] 7.2 实现实例矩阵更新

    - 编写 updateBatches() 方法动态更新实例矩阵
    - 实现位置、旋转、缩放的实例属性设置
    - 添加颜色实例属性支持不同颜色的方块
    - 只为可见物体创建实例
    - _需求: 6.1, 6.4_


  - [x] 7.3 集成批处理到渲染流程

    - 修改 createNoteBlock() 添加对象到批处理器
    - 在渲染前调用 updateBatches()
    - 当方块数量 > 100 时启用批处理
    - 添加批处理统计数据显示
    - _需求: 6.2, 6.3, 6.4_

- [x] 8. 实现阴影优化




  - [x] 8.1 实现动态阴影分辨率调整

    - 根据画质级别设置阴影贴图大小
    - 在 QualityAdapter 中集成阴影分辨率配置
    - 实现阴影贴图的动态重建
    - _需求: 8.1_



  - [x] 8.2 实现距离阴影剔除

    - 为超过50单位的物体禁用阴影投射
    - 在 updateNoteBlocks() 中动态更新 castShadow 属性
    - 限制同时投射阴影的光源数量为2个
    - _需求: 8.2, 8.4_


  - [x] 8.3 实现级联阴影贴图

    - 研究 Three.js 的 CSM（Cascaded Shadow Maps）实现
    - 配置多个阴影层级优化远近阴影质量
    - 测试性能影响并调整参数
    - _需求: 8.3_

- [x] 9. 实现后处理效果系统







  - [x] 9.1 创建 PostProcessing 类

    - 初始化 EffectComposer 和渲染目标
    - 实现 setEnabled() 方法启用/禁用后处理
    - 编写 render() 方法替代直接渲染
    - 添加效果强度调整接口
    - _需求: 5.3, 5.4_




  - [ ] 9.2 实现泛光效果
    - 添加 UnrealBloomPass 到后处理管线
    - 配置泛光参数（强度0.5、阈值0.8、半径0.4）
    - 只对白色物体（触发线、已触发方块）应用泛光
    - _需求: 5.1_



  - [ ] 9.3 实现环境光遮蔽效果
    - 添加 SSAOPass 到后处理管线
    - 配置SSAO参数（半径0.5、强度0.3）
    - 仅在 high/ultra 画质启用
    - 监控性能，FPS < 45 时自动禁用

    - _需求: 5.2, 5.3_

  - [x] 9.4 集成后处理到渲染流程

    - 修改 animate() 函数使用 postProcessing.render()
    - 根据画质级别自动启用/禁用后处理
    - 添加后处理效果的UI开关
    - _需求: 5.4_


- [x] 10. 实现内存管理系统





  - [x] 10.1 添加内存监控


    - 在 PerformanceMonitor 中集成 renderer.info.memory 监控
    - 实现内存使用情况的实时记录
    - 设置内存警告阈值（几何体>1000，纹理>100）
    - _需求: 7.4_

  - [x] 10.2 实现资源清理机制


    - 编写 checkMemoryUsage() 函数定期检查内存
    - 实现远距离对象的强制清理（超过200单位）
    - 在场景切换时清理所有未使用的资源
    - 确保 disposeObject() 正确释放GPU内存
    - _需求: 7.1, 7.2, 7.3_

  - [x] 10.3 实现内存溢出保护


    - 当内存超过80%时触发紧急清理
    - 自动降低画质级别
    - 减少对象池大小
    - 显示内存警告提示
    - _需求: 7.2_

- [x] 11. 实现错误处理和恢复




  - [x] 11.1 处理WebGL上下文丢失


    - 添加 webglcontextlost 事件监听器
    - 暂停游戏并显示错误提示
    - 实现自动恢复逻辑（1秒后尝试恢复）
    - 添加 webglcontextrestored 事件处理
    - _需求: 7.1, 7.3_

  - [x] 11.2 实现性能降级失败处理


    - 检测最低画质下仍低于25 FPS的情况
    - 显示性能警告提示
    - 提供"极简模式"选项（禁用特效、阴影，降低分辨率）
    - _需求: 1.1_

- [ ] 12. 集成和优化




  - [x] 12.1 整合所有子系统到 RenderManager

    - 在 RenderManager.initialize() 中初始化所有子系统
    - 实现 update() 方法按顺序调用各子系统
    - 实现 render() 方法协调渲染流程
    - 添加性能统计聚合接口
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [x] 12.2 修改游戏主循环



    - 更新 animate() 函数集成 RenderManager
    - 添加 performanceMonitor.beginFrame() 和 endFrame()
    - 替换直接渲染为 renderManager.render()
    - 确保所有现有功能正常工作
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [x] 12.3 优化共享资源


    - 确保所有方块使用共享几何体
    - 实现材质实例化减少材质数量
    - 优化边缘线材质的共享
    - 验证内存使用显著降低
    - _需求: 3.1, 3.2, 3.3, 3.4_

  - [ ] 12.4 性能基准测试


    - 测试100、500、1000个方块的性能表现
    - 在低端、中端、高端设备上验证FPS目标
    - 测试长时间运行的内存稳定性
    - 验证渲染调用次数减少至少50%
    - 记录优化前后的性能对比数据
    - _需求: 1.1, 1.2, 6.3_


- [x] 13. 用户界面增强





  - [x] 13.1 添加画质设置UI


    - 在设置页面添加画质级别选择器（低/中/高/超高）
    - 添加自动调整画质的开关
    - 实现画质设置的实时预览
    - 保存用户的画质偏好到 localStorage
    - _需求: 1.1, 1.2_

  - [x] 13.2 添加后处理效果开关


    - 在设置页面添加后处理效果的开关
    - 添加泛光效果强度滑块
    - 实现效果的实时切换
    - _需求: 5.4_

  - [x] 13.3 添加性能统计显示


    - 创建可折叠的性能统计面板
    - 显示FPS、渲染调用、三角形数量、内存使用
    - 添加LOD和剔除统计信息
    - 仅在开发模式下显示
    - _需求: 9.1, 9.2, 9.3, 9.4_

- [ ] 14. 文档和测试
  - [ ] 14.1 编写代码文档
    - 为所有类和方法添加JSDoc注释
    - 编写渲染系统使用指南
    - 创建性能优化最佳实践文档
    - _需求: 所有需求_

  - [ ] 14.2 编写单元测试
    - 为 ObjectPool 编写测试用例
    - 为 FrustumCuller 编写测试用例
    - 为 LODManager 编写测试用例
    - 为 PerformanceMonitor 编写测试用例
    - _需求: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4_

  - [ ] 14.3 进行集成测试
    - 测试所有子系统协同工作
    - 验证画质自动调整功能
    - 测试内存管理和资源清理
    - 验证错误恢复机制
    - _需求: 所有需求_

  - [ ] 14.4 进行兼容性测试
    - 在 Chrome、Firefox、Safari、Edge 上测试
    - 在 Windows、macOS、iOS、Android 上测试
    - 验证 WebGL 1.0 和 2.0 兼容性
    - 测试不同屏幕分辨率和像素比
    - _需求: 所有需求_

